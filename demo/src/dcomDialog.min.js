"use strict";angular.module("dcomDialog",[]).service("dialogService",["$q","$http","$templateCache","$document","$timeout",function(a,b,c,d,e){function f(a,b){for(var c=0,d=j.length;d>c;c++)if(j[c][a]==b)return j[c];return null}function g(){var a=this;e(function(){var b=j.indexOf(a);-1!=b&&(a.callStackArray("destroy"),a._ready=!1,j.splice(b,1))})}var h=0,i="templates/default.html",j=[],k=[],l=function(b,c){if(b){h++;var d=this;if(this.id=h,this.name=b,this.template=null,this.controller=null,this.className=null,this._persistent=!1,this._backdropDisabled=!1,this._ready=!1,this._loadDirective=a.defer(),this._originalTemplate="templates/"+b+".html",c&&angular.isObject(c))if(this.className=c.className,this._persistent=c.persistent,this._backdropDisabled=c.backdrop===!1,angular.isObject(c.controller)){var e=function(a){for(var b in c.controller)a[b]=c.controller[b];e.$inject=["$scope"],this.$scope=a};this.controller=e}else angular.isFunction(c.controller)&&(this.controller=c.controller);this._callStack={dismiss:[],destroy:[],ready:[],open:[]},j.push(this),this.loadTemplate().then(function(a){d.template=a,d._loadDirective.promise.then(function(){d._ready=!0,d.callStackArray("ready")})},function(){console.error("Template not specified")})}};return l.prototype={loadTemplate:function(){if(this.deferLoad=a.defer(),this._ready)this.deferLoad.resolve(this.template);else if(this._originalTemplate){var d=this;b.get(this._originalTemplate,{cache:c}).success(function(){d.deferLoad.resolve(d._originalTemplate)}).error(function(){d.deferLoad.resolve(i)})}else this.deferLoad.reject();return this.deferLoad.promise},open:function(b){b&&b.preventDefault();var c=a.defer(),d=this,e=function(){d.show(),k.unshift(d.id),c.resolve(),d.callStackArray("open")};return-1===j.indexOf(this)?(c.reject(),console.warn("Dialog does not exist")):this._ready&&-1===k.indexOf(this.id)?e():this.on("ready",e),c.promise},dismiss:function(b){b&&b.preventDefault();var c=a.defer(),d=k.indexOf(this.id);return this._ready&&-1!==d?(this.hide(),k.splice(d,1),this.callStackArray("dismiss"),c.resolve()):c.reject(),c.promise},destroy:function(){var a=this;this.dismiss().then(function(){g.call(a)},function(){g.call(a)})},on:function(a,b){b&&a&&angular.isFunction(b)&&a in this._callStack&&this._callStack[a].push(b)},callStackArray:function(a){for(var b=this._callStack[a]||[],c=0,d=b.length;d>c;c++)b[c].call(this)},close:function(a){this._persistent?this.dismiss(a):this.destroy()},backdropClick:function(a){a&&a.preventDefault(),this._backdropDisabled||this.close()}},{create:function(a,b){return new l(a,b)},get:function(a){return f("name",a)},getById:function(a){return f("id",a)},allDialogs:function(){return j},openedDialogs:function(){return k}}}]).directive("dcomDialogWidget",["dialogService","$document",function(a,b){return{priority:10,replace:!0,templateUrl:"src/spine.html",link:function(c){c.allDialogs=a.allDialogs,c.openedDialogs=a.openedDialogs,b.keyup(function(b){var d=a.openedDialogs()[0];c.$apply(function(){27==b.keyCode&&d&&a.getById(d).close(b)&&b.preventDefault()})})}}}]).directive("dcomDialog",["dialogService",function(a){return{priority:200,link:function(b,c){var d={show:!0,backdrop:!1,keyboard:!1},e=a.getById(b.dialog.id);e.show=function(){c.modal(d)},e.hide=function(){c.modal("hide")},e._loadDirective.resolve()}}}]).directive("dcomDialogBackdrop",["dialogService",function(a){return{priority:100,replace:!0,template:'<div class="dcomDialogBackdrop" ng-class="{shown: showBackdrop()}"></div>',link:function(b,c){b.showBackdrop=function(){return b.openedDialogs().length},c.on("click",function(c){b.$apply(function(){a.getById(b.openedDialogs()[0]).backdropClick(c)})})}}}]);