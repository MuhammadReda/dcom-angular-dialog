"use strict";angular.module("dcomDialog",[]).service("dialogService",["$q","$http","$templateCache","$document","$timeout",function(a,b,c,d,e){function f(a,b){for(var c=0,d=j.length;d>c;c++)if(j[c][a]==b)return j[c];return null}function g(){var a=this;e(function(){a.callStackArray("destroy"),j.splice(j.indexOf(a),1)})}var h=0,i="templates/default.html",j=[],k=[],l=function(b,c,d,e){if(b){h++;var f=this;if(this.id=h,this.name=b,this.template=null,this.className=c,this.controller=null,this._persistent=e||!1,this._ready=!1,this._linkDefer=a.defer(),this._originalTemplate="templates/"+b+".html",angular.isObject(d)){var g=function(a){for(var b in d)a[b]=d[b];g.$inject=["$scope"],this.$scope=a};this.controller=g}else angular.isFunction(d)&&(this.controller=d);this._callStack={dismiss:[],destroy:[],ready:[],open:[]},j.push(this),this.loadTemplate().then(function(a){f.template=a,f._linkDefer.promise.then(function(){f._ready=!0,f.callStackArray("ready")})},function(){debug.error("Dialog template not specified")})}};return l.prototype.loadTemplate=function(){if(this.deferLoad=a.defer(),this._ready)this.deferLoad.resolve(this.template);else if(this._originalTemplate){var d=this;b.get(this._originalTemplate,{cache:c}).success(function(){d.deferLoad.resolve(d._originalTemplate)}).error(function(){d.deferLoad.resolve(i)})}else this.deferLoad.reject();return this.deferLoad.promise},l.prototype.open=function(b){b&&b.preventDefault();var c=a.defer(),d=this,e=function(){d.showModal(),k.unshift(d.id),c.resolve(),d.callStackArray("open")};return this._ready&&-1===k.indexOf(this.id)?e():this.on("ready",e),c.promise},l.prototype.dismiss=function(b){b&&b.preventDefault();var c=a.defer(),d=k.indexOf(this.id);return this._ready&&-1!==d?(this.hideModal(),k.splice(d,1),this.callStackArray("dismiss"),c.resolve()):c.reject(),c.promise},l.prototype.destroy=function(){var a=this;this.dismiss().then(function(){g.call(a)},function(){g.call(a)})},l.prototype.on=function(a,b){b&&a&&angular.isFunction(b)&&a in this._callStack&&this._callStack[a].push(b)},l.prototype.callStackArray=function(a){for(var b=this._callStack[a]||[],c=0,d=b.length;d>c;c++)b[c].call(this)},l.prototype.close=function(){this._persistent?this.dismiss():this.destroy()},this.create=function(a,b,c,d){return new l(a,b,c,d)},this.get=function(a){return f("name",a)},this.getByClass=function(a){return f("className",a)},this.getById=function(a){return f("id",a)},this.allDialogs=function(){return j},this.openedDialogs=function(){return k},this}]).directive("dcomDialogWidget",["dialogService","$document",function(a,b){return{priority:10,replace:!0,templateUrl:"src/spine.html",link:function(c){c.allDialogs=a.allDialogs,c.openedDialogs=a.openedDialogs,b.keyup(function(b){var d=a.openedDialogs()[0];c.$apply(function(){27==b.keyCode&&d&&a.getById(d).dismiss(b)&&b.preventDefault()})})}}}]).directive("dcomDialog",["dialogService",function(a){return{priority:200,link:function(b,c){var d={show:!0,backdrop:!1,keyboard:!1},e=a.getById(b.dialog.id);e.showModal=function(){c.modal(d)},e.hideModal=function(){c.modal("hide")},e._linkDefer.resolve()}}}]).directive("dcomDialogBackdrop",["dialogService",function(a){return{priority:100,replace:!0,template:'<div class="dcomDialogBackdrop" ng-class="{shown: showBackdrop()}"></div>',link:function(b,c){b.showBackdrop=function(){return b.openedDialogs().length},c.on("click",function(c){b.$apply(function(){a.getById(b.openedDialogs()[0]).close(c)})})}}}]);